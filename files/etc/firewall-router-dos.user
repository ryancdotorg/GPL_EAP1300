# This file is interpreted as shell script.
# Put your custom iptables rules here, they will
# be executed with each firewall (re-)start and reload.

# Internal uci firewall chains are flushed and recreated on reload, so
# put custom rules into the root chains e.g. INPUT or FORWARD or into the
# special user chains, e.g. input_wan_rule or postrouting_lan_rule.
#
# INPUT  {delegate_input
#           {input_rule,
#            zone_lan_input,
#               {input_lan_rule,
#                zone_lan_src_ACCEPT}
#            zone_guest_input
#               {input_guest_rule,
#                zone_guest_src_DROP}
#            }
#        }
# OUTPUT {delegate_output
#           {output_rule,
#            zone_lan_output,
#               {output_lan_rule,
#                zone_lan_dest_ACCEPT}
#            zone_guest_output
#               {output_guest_rule,
#               zone_guest_dest_ACCEPT}
#           }
#        }
# FORWARD {delegate_forward
#           {forwarding_rule,
#            zone_lan_forward
#                {forwarding_lan_rule,
#                 zone_lan_src_ACCEPT},
#            zone_guest_forward
#                {forwarding_guest_rule,
#                 zone_lan_dest_ACCEPT,
#                 zone_guest_src_DROP
#                }
#           }
#         }
# nat: POSTROUTING { delegate_postrouting { postrouting_rule, zone_lan_postrouting {postrouting_lan_rule}, zone_guest_postrouting{postrouting_guest_rule}} }
#
# :forwarding_guest_rule - [0:0]
# :forwarding_lan_rule - [0:0]
# :forwarding_rule - [0:0]
# :input_guest_rule - [0:0]
# :input_lan_rule - [0:0]
# :input_rule - [0:0]
# :output_guest_rule - [0:0]
# :output_lan_rule - [0:0]
# :output_rule - [0:0]
#
# Yolin NOTE: don't put random rule into xxx_xxx_rule!!

if [ -z "$(uci -q get network.wan)" ]; then
	return
fi

if [ "$(uci -q get sn_firewall.firewall.enable)" -ne 1 ]; then
	return
fi

# Ping of Death
iptables -F bad-ping
if [ "$(uci -q get sn_firewall.dos.pingofdeath_en)" == "1" ]; then
	limit=$(uci -q get sn_firewall.dos.pingpacket)
	limit_burst=$(uci -q get sn_firewall.dos.pingburst)
	iptables -I bad-ping -p icmp -m icmp --icmp-type 8 -m limit --limit $limit/sec --limit-burst $limit_burst -j ACCEPT

	iptables -A bad-ping -p icmp -m icmp --icmp-type 8 -j DROP

	if [ "$(uci -q get sn_firewall.dos.discard_ping_from_wan)" == "1" ]; then
		iptables -I delegate_input -i br-lan -p icmp --icmp-type echo-request -j bad-ping
	else
		iptables -I delegate_input -p icmp --icmp-type echo-request -j bad-ping
	fi
fi

# Discard Ping from WAN
# Use firewall.@rule[x].name="Allow-Ping"

# Port Scan
# There is no rule for port scan.

# Sync Flood
# Use firewall.@defaults[0].syn_flood
